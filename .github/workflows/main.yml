name: Fetch Tamil Movies (Per-Category, Fixed)

on:
  workflow_dispatch:
  # schedule:
  #   - cron: '*/10 * * * *'

jobs:
  update-m3u:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Fetch & Build M3U
        env:
          XTREAM_USER: "8zpo3GsVY7"
          XTREAM_PASS: "beneficial2concern"
          XTREAM_HOST: "http://webhop.live"
        run: |
          HOST="$XTREAM_HOST"
          OUTPUT="tamil_movies.m3u"

          {
            echo "#EXTM3U"
            echo "# Auto-updated: $(date -u)"
            echo "# Source: $HOST"
            echo ""
          } > "$OUTPUT"

          # Fetch categories
          CATEGORIES=$(curl -s "${HOST}/player_api.php?username=${XTREAM_USER}&password=${XTREAM_PASS}&action=get_vod_categories")
          if ! echo "$CATEGORIES" | jq 'type == "array"' >/dev/null; then
            echo "‚ùå Categories API failed"
            exit 1
          fi

          # Get Tamil categories as JSON array: [{"id":"602","name":"TAMIL (2025)"},...]
          TAMIL_CATS=$(echo "$CATEGORIES" | jq -c '
            [.[] | 
              select(.category_name | ascii_downcase | contains("tamil")) |
              {id: (.category_id | tostring), name: .category_name}
            ]
          ')

          TOTAL=0

          # Iterate in Bash (no subshell!)
          for row in $(echo "$TAMIL_CATS" | jq -r '.[] | @base64'); do
            _jq() { echo "$row" | base64 -d | jq -r "$1"; }
            cid=$(_jq '.id')
            cname=$(_jq '.name')

            echo "üé¨ $cname (ID: $cid)"
            VODS=$(curl -s "${HOST}/player_api.php?username=${XTREAM_USER}&password=${XTREAM_PASS}&action=get_vod_streams&category_id=${cid}")

            # Count and append
            COUNT=$(echo "$VODS" | jq 'length // 0')
            echo "  ‚Üí $COUNT movies"

            if [ "$COUNT" -gt 0 ]; then
              echo "$VODS" | jq -r --arg group "$cname" '
                .[] |
                select(.stream_url) |
                "#EXTINF:-1 tvg-logo=\"" + (.stream_icon // "" | @json | .[1:-1]) +
                "\" group-title=\"" + ($group | @json | .[1:-1]) +
                "\", " + (.name // "Unknown" | @json | .[1:-1]) +
                "\n" + .stream_url
              ' >> "$OUTPUT"
              TOTAL=$((TOTAL + COUNT))
            fi
          done

          echo "‚úÖ Total fetched: $TOTAL movies"

          # Final cleanup
          if [ ! -s "$OUTPUT" ] || [ "$TOTAL" -eq 0 ]; then
            echo "üõë No valid streams found"
            exit 1
          fi

          # Remove blank lines and malformed entries
          sed -i '/^$/d; /^#EXTINF/ {N; /http/!D;}' "$OUTPUT"

          FINAL_COUNT=$(grep -c '^http' "$OUTPUT" 2>/dev/null || echo 0)
          echo "üì§ Final unique streams: $FINAL_COUNT"

          if [ "$FINAL_COUNT" -eq 0 ]; then
            echo "‚ö†Ô∏è M3U has no valid URLs"
            exit 1
          fi

      - name: Commit
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"

          if git add tamil_movies.m3u && ! git diff --staged --quiet; then
            git commit -m "ü§ñ $FINAL_COUNT Tamil movies ($(date -u))"
            git push
          else
            echo "‚è≠Ô∏è No changes"
          fi
