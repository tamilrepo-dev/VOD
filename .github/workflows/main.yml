name: Fetch Tamil Movies M3U (Every 10 mins)

on:
  schedule:
    - cron: '*/10 * * * *'
  workflow_dispatch:

jobs:
  update-m3u:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Fetch Tamil Movies from webhop.live
        env:
          XTREAM_USER: "8zpo3GsVY7"
          XTREAM_PASS: "beneficial2concern"
          XTREAM_HOST: "http://webhop.live"
        run: |
          HOST="$XTREAM_HOST"
          OUTPUT="tamil_movies.m3u"
          echo "ğŸ“¡ Using single host: $HOST"

          # Fetch categories
          CATEGORIES_URL="${HOST}/player_api.php?username=${XTREAM_USER}&password=${XTREAM_PASS}&action=get_vod_categories"
          CATEGORIES=$(curl -s --max-time 20 "$CATEGORIES_URL")

          if ! echo "$CATEGORIES" | jq 'type == "array"' >/dev/null 2>&1; then
            echo "âŒ Invalid categories JSON"
            exit 1
          fi

          # Fetch VOD list
          VOD_URL="${HOST}/player_api.php?username=${XTREAM_USER}&password=${XTREAM_PASS}&action=get_vod_streams"
          VOD_LIST=$(curl -s --max-time 30 "$VOD_URL")

          if ! echo "$VOD_LIST" | jq 'type == "array"' >/dev/null 2>&1; then
            echo "âŒ Invalid VOD list JSON"
            exit 1
          fi

          # Log Tamil categories & IDs (debug)
          echo "$CATEGORIES" | jq -r '
            .[] |
            select(.category_name | ascii_downcase | contains("tamil")) |
            "ğŸ“Œ \(.category_name) â†’ ID: \(.category_id)"
          ' | while IFS= read -r line; do echo "$line"; done

          # Build M3U header
          {
            echo "#EXTM3U"
            echo "# Auto-updated: $(date -u)"
            echo "# Source: $HOST"
            echo ""
          } > "$OUTPUT"

          # âœ… SMART MATCH: handle numeric/string/category_ids
          echo "$VOD_LIST" | jq -r --argjson cats "$CATEGORIES" '
            # Get set of Tamil category IDs (as strings â€” safest for comparison)
            ($cats | map(select(.category_name | ascii_downcase | contains("tamil"))) | map(.category_id | tostring)) as $tamil_ids |

            .[] |
            # Try: category_id (single), category_ids (array), or cat_id
            (.category_id // .cat_id // (if .category_ids and (.category_ids | length > 0) then .category_ids[0] else null end)) as $cid |
            select($cid) |
            ($cid | tostring) as $cid_str |
            select($tamil_ids | index($cid_str)) |
            # Safe fields
            (.name // "Unknown") as $name |
            (.stream_icon // "") as $logo |
            (.category_name // "Tamil") as $group |
            (.stream_url // null) as $url |
            select($url) |
            "#EXTINF:-1 tvg-logo=\"" + ($logo | @json | .[1:-1]) +
            "\" group-title=\"" + ($group | @json | .[1:-1]) +
            "\", " + ($name | @json | .[1:-1]) +
            "\n" + $url
          ' >> "$OUTPUT"

          # Cleanup & count
          sed -i '/^$/d; /^#EXTINF/ {N; /http/!D;}' "$OUTPUT"
          COUNT=$(grep -c '^http' "$OUTPUT" 2>/dev/null || echo 0)

          echo "âœ… Final count: $COUNT Tamil movies"

          if [ "$COUNT" -eq 0 ]; then
            echo "ğŸ›‘ No movies found â€” check category_id format or server status."
            exit 1
          fi

      - name: Commit and push
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"

          if git add tamil_movies.m3u && ! git diff --staged --quiet; then
            git commit -m "ğŸ¤– Auto-update: $COUNT Tamil movies ($(date -u))"
            git push
          else
            echo "â­ï¸ No changes"
          fi
