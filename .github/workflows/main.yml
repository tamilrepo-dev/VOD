name: Fetch Tamil Movies (Construct URLs)

on:
  workflow_dispatch:

jobs:
  update-m3u:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Build Tamil Movies M3U
        env:
          XTREAM_USER: "8zpo3GsVY7"
          XTREAM_PASS: "beneficial2concern"
          XTREAM_HOST: "http://webhop.live"
        run: |
          HOST="$XTREAM_HOST"
          USER="$XTREAM_USER"
          PASS="$XTREAM_PASS"
          OUTPUT="tamil_movies.m3u"

          {
            echo "#EXTM3U"
            echo "# Auto-updated: $(date -u)"
            echo "# Source: $HOST"
            echo ""
          } > "$OUTPUT"

          CATEGORIES=$(curl -s "${HOST}/player_api.php?username=${USER}&password=${PASS}&action=get_vod_categories")
          echo "$CATEGORIES" | jq empty >/dev/null || { echo "âŒ Categories failed"; exit 1; }

          # Get Tamil categories
          TAMIL_CATS=$(echo "$CATEGORIES" | jq -c '
            [.[] | 
              select(.category_name | ascii_downcase | contains("tamil")) |
              {id: (.category_id | tostring), name: .category_name}
            ]
          ')

          TOTAL=0

          for row in $(echo "$TAMIL_CATS" | jq -r '.[] | @base64'); do
            _jq() { echo "$row" | base64 -d | jq -r "$1"; }
            cid=$(_jq '.id')
            cname=$(_jq '.name')
            echo "ğŸ¬ $cname (ID: $cid)"

            VODS=$(curl -s "${HOST}/player_api.php?username=${USER}&password=${PASS}&action=get_vod_streams&category_id=${cid}")
            COUNT=$(echo "$VODS" | jq 'length // 0')
            echo "  â†’ $COUNT movies"

            if [ "$COUNT" -gt 0 ]; then
              # Extract name, icon, id, ext â€” then construct URL in Bash
              echo "$VODS" | jq -r --arg group "$cname" --arg host "$HOST" --arg user "$USER" --arg pass "$PASS" '
                .[] |
                select(.stream_id) |
                (.name // "Unknown") as $name |
                (.stream_icon // "") as $logo |
                (.container_extension // "mp4") as $ext |
                (.stream_id | tostring) as $id |
                "#EXTINF:-1 tvg-logo=\"" + ($logo | @json | .[1:-1]) +
                "\" group-title=\"" + ($group | @json | .[1:-1]) +
                "\", " + ($name | @json | .[1:-1]) +
                "\n" + $host + "/movie/" + $user + "/" + $pass + "/" + $id + "." + $ext
              ' >> "$OUTPUT"
              TOTAL=$((TOTAL + COUNT))
            fi
          done

          echo "âœ… Total entries attempted: $TOTAL"

          # Cleanup & count real URLs
          sed -i '/^$/d; /^#EXTINF/ {N; /http/!D;}' "$OUTPUT"
          FINAL=$(grep -c '^http' "$OUTPUT" 2>/dev/null || echo 0)

          echo "ğŸ“¤ Final working streams: $FINAL"

          if [ "$FINAL" -eq 0 ]; then
            echo "ğŸ›‘ M3U is empty. Sample of what was generated:"
            head -n 6 "$OUTPUT" || echo "(empty)"
            exit 1
          fi

      - name: Commit
        run: |
          git add tamil_movies.m3u
          if ! git diff --staged --quiet; then
            git config --global user.name "github-actions[bot]"
            git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"
            git commit -m "ğŸ¤– $FINAL Tamil movies ($(date -u))"
            git push
          else
            echo "â­ï¸ No changes"
          fi
