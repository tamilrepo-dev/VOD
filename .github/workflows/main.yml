name: Fetch Tamil Movies (Per-Category)

on:
  workflow_dispatch:
  # schedule:
  #   - cron: '*/10 * * * *'

jobs:
  update-m3u:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Fetch Tamil Movies by Category
        env:
          XTREAM_USER: "8zpo3GsVY7"
          XTREAM_PASS: "beneficial2concern"
          XTREAM_HOST: "http://webhop.live"
        run: |
          HOST="$XTREAM_HOST"
          OUTPUT="tamil_movies.m3u"
          echo "#EXTM3U" > "$OUTPUT"
          echo "# Auto-updated: $(date -u)" >> "$OUTPUT"
          echo "# Source: $HOST" >> "$OUTPUT"
          echo "" >> "$OUTPUT"

          TOTAL=0

          # Fetch categories once
          CATEGORIES=$(curl -s "${HOST}/player_api.php?username=${XTREAM_USER}&password=${XTREAM_PASS}&action=get_vod_categories")
          if ! echo "$CATEGORIES" | jq 'type == "array"' >/dev/null; then
            echo "‚ùå Categories failed"
            exit 1
          fi

          # Get Tamil IDs & names
          echo "$CATEGORIES" | jq -r '
            .[] |
            select(.category_name | ascii_downcase | contains("tamil")) |
            "\(.category_id):\(.category_name)"
          ' | while IFS=':' read -r cid cname; do
            echo "üé¨ Fetching category: $cname (ID: $cid)"
            
            # Fetch VODs for this category only
            VODS=$(curl -s "${HOST}/player_api.php?username=${XTREAM_USER}&password=${XTREAM_PASS}&action=get_vod_streams&category_id=${cid}")
            
            COUNT=$(echo "$VODS" | jq 'length // 0')
            echo "  ‚Üí $COUNT movies"

            # Append to M3U
            echo "$VODS" | jq -r --arg group "$cname" '
              .[] |
              select(.stream_url) |
              "#EXTINF:-1 tvg-logo=\"" + (.stream_icon // "" | @json | .[1:-1]) +
              "\" group-title=\"" + ($group | @json | .[1:-1]) +
              "\", " + (.name // "Unknown" | @json | .[1:-1]) +
              "\n" + .stream_url
            ' >> "$OUTPUT"

            TOTAL=$((TOTAL + COUNT))
          done

          echo "‚úÖ Total Tamil movies: $TOTAL"

          if [ "$TOTAL" -eq 0 ]; then
            echo "üõë No movies found"
            exit 1
          fi

      - name: Cleanup & Push
        run: |
          # Remove duplicates (by URL)
          awk '!seen[$0]++' tamil_movies.m3u > tmp && mv tmp tamil_movies.m3u

          # Count final
          COUNT=$(grep -c '^http' tamil_movies.m3u || echo 0)
          echo "üì§ Final unique movies: $COUNT"

          git config --global user.name "github-actions[bot]"
          git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"

          if ! git add tamil_movies.m3u || git diff --staged --quiet; then
            echo "‚è≠Ô∏è No changes"
          else
            git commit -m "ü§ñ $COUNT Tamil movies ($(date -u))"
            git push
          fi
