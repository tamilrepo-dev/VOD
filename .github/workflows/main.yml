name: Fetch Tamil Movies M3U (Every 10 mins)

on:
  schedule:
    - cron: '*/10 * * * *'   # Every 10 minutes
  workflow_dispatch:         # Manual run (test anytime)

jobs:
  update-m3u:
    runs-on: ubuntu-latest
    permissions:
      contents: write        # Allows push using GITHUB_TOKEN

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Fetch & Generate Tamil Movies M3U
        env:
          XTREAM_USER: "8zpo3GsVY7"
          XTREAM_PASS: "beneficial2concern"
          XTREAM_HOSTS: |
            http://webhop.live
            http://livetvbox.live
            http://starshare.st
            http://starshare.org
            http://starhub.pro
            http://starshare.cx
        run: |
          readarray -t HOSTS <<< "$XTREAM_HOSTS"
          OUTPUT="tamil_movies.m3u"
          FOUND=0

          for HOST in "${HOSTS[@]}"; do
            HOST=$(echo "$HOST" | xargs)
            [[ -z "$HOST" ]] && continue

            echo "üì° Trying host: $HOST"

            # Fetch categories
            CATEGORIES_URL="${HOST}/player_api.php?username=${XTREAM_USER}&password=${XTREAM_PASS}&action=get_vod_categories"
            CATEGORIES=$(curl -s --max-time 20 --retry 2 "$CATEGORIES_URL")

            # Validate categories: must be non-empty JSON array
            if ! echo "$CATEGORIES" | jq 'select(type == "array") | length >= 0' >/dev/null 2>&1; then
              echo "‚ùå Invalid categories JSON from $HOST"
              continue
            fi

            # Fetch VOD list
            VOD_URL="${HOST}/player_api.php?username=${XTREAM_USER}&password=${XTREAM_PASS}&action=get_vod_streams"
            VOD_LIST=$(curl -s --max-time 30 --retry 2 "$VOD_URL")

            if ! echo "$VOD_LIST" | jq 'select(type == "array") | length >= 0' >/dev/null 2>&1; then
              echo "‚ùå Invalid VOD list JSON from $HOST"
              continue
            fi

            # Log matched Tamil category names (for visibility)
            TAMIL_NAMES=$(echo "$CATEGORIES" | jq -r '
              .[] |
              select(.category_name | ascii_downcase | contains("tamil")) |
              .category_name
            ')
            COUNT_NAMES=$(echo "$TAMIL_NAMES" | grep -c '^[^[:space:]]' || echo 0)
            echo "üé¨ Found $COUNT_NAMES Tamil categories: $(echo "$TAMIL_NAMES" | paste -sd ', ' -)"

            # Write M3U header
            {
              echo "#EXTM3U"
              echo "# Auto-updated: $(date -u)"
              echo "# Source: $HOST"
              echo ""
            } > "$OUTPUT"

            # Filter VODs using pure jq (safe, no shell interpolation)
            echo "$VOD_LIST" | jq -r --argjson categories "$CATEGORIES" '
              # Build list of Tamil category IDs
              ($categories | map(select(.category_name | ascii_downcase | contains("tamil"))) | map(.category_id)) as $tamil_ids |
              # Filter VODs
              .[] |
              select(.category_id as $id | $tamil_ids | index($id)) |
              "#EXTINF:-1 tvg-logo=\"\(.stream_icon // \"\")\" group-title=\"\(.category_name // \"Tamil\")\", \(.name)\n\(.stream_url // \"\")"
            ' >> "$OUTPUT"

            # Cleanup: remove entries without valid URLs
            sed -i '/^$/d; /^#EXTINF/ {N; /http/!D;}' "$OUTPUT"

            COUNT=$(grep -c '^http' "$OUTPUT" 2>/dev/null || echo 0)
            echo "‚úÖ Success! $COUNT Tamil movies from $HOST"

            if [ "$COUNT" -eq 0 ]; then
              echo "‚ö†Ô∏è 0 movies ‚Äî trying next host‚Ä¶"
              continue
            fi

            FOUND=1
            break
          done

          if [ "$FOUND" -eq 0 ]; then
            echo "üí• All hosts failed or returned 0 Tamil movies."
            exit 1
          fi

      - name: Commit and push (if changed)
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"

          git add tamil_movies.m3u

          if git diff --staged --quiet; then
            echo "‚è≠Ô∏è No changes ‚Äî skipping commit."
            exit 0
          fi

          git commit -m "ü§ñ Auto-update: Tamil Movies M3U ($(date -u))"
          git push
