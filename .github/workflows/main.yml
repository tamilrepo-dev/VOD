name: Fetch Tamil Movies M3U (Every 10 mins)

on:
  schedule:
    - cron: '*/10 * * * *'
  workflow_dispatch:

jobs:
  update-m3u:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Fetch & Generate Tamil Movies M3U
        env:
          XTREAM_USER: "8zpo3GsVY7"
          XTREAM_PASS: "beneficial2concern"
          XTREAM_HOSTS: |
            http://webhop.live
            http://livetvbox.live
            http://starshare.st
            http://starshare.org
            http://starhub.pro
            http://starshare.cx
        run: |
          readarray -t HOSTS <<< "$XTREAM_HOSTS"
          OUTPUT="tamil_movies.m3u"
          FOUND=0

          for HOST in "${HOSTS[@]}"; do
            HOST=$(echo "$HOST" | xargs)
            [[ -z "$HOST" ]] && continue

            echo "üì° Trying host: $HOST"

            # Fetch categories
            CATEGORIES_URL="${HOST}/player_api.php?username=${XTREAM_USER}&password=${XTREAM_PASS}&action=get_vod_categories"
            CATEGORIES=$(curl -s --max-time 20 --retry 2 "$CATEGORIES_URL")

            # Validate categories is JSON array
            if ! echo "$CATEGORIES" | jq 'type == "array"' >/dev/null 2>&1; then
              echo "‚ùå Invalid categories JSON from $HOST"
              continue
            fi

            # Fetch VOD list
            VOD_URL="${HOST}/player_api.php?username=${XTREAM_USER}&password=${XTREAM_PASS}&action=get_vod_streams"
            VOD_LIST=$(curl -s --max-time 30 --retry 2 "$VOD_URL")

            if ! echo "$VOD_LIST" | jq 'type == "array"' >/dev/null 2>&1; then
              echo "‚ùå Invalid VOD list JSON from $HOST"
              continue
            fi

            # Log Tamil category names
            TAMIL_NAMES=$(echo "$CATEGORIES" | jq -r '
              .[] |
              select(.category_name | ascii_downcase | contains("tamil")) |
              .category_name
            ' | grep -v '^$')
            COUNT_NAMES=$(echo "$TAMIL_NAMES" | wc -l)
            echo "üé¨ Found $COUNT_NAMES Tamil categories: $(echo "$TAMIL_NAMES" | paste -sd ', ' -)"

            # Write M3U header
            {
              echo "#EXTM3U"
              echo "# Auto-updated: $(date -u)"
              echo "# Source: $HOST"
              echo ""
            } > "$OUTPUT"

            # ‚úÖ SAFE jq: no manual escaping, no broken pipes
            echo "$VOD_LIST" | jq -r --argjson cats "$CATEGORIES" '
              # Extract Tamil category IDs
              ($cats | map(select(.category_name | ascii_downcase | contains("tamil"))) | map(.category_id)) as $tids |
              # Process each VOD
              .[] |
              select(.category_id as $id | $tids | index($id)) |
              # Safe fallbacks & escaping
              (.name // "Unknown") as $name |
              (.stream_icon // "") as $logo |
              (.category_name // "Tamil") as $group |
              (.stream_url // null) as $url |
              # Skip if no stream URL
              select($url) |
              # Build EXTINF line: escape quotes inside JSON strings
              "#EXTINF:-1 tvg-logo=\"" + ($logo | @json | .[1:-1]) + 
              "\" group-title=\"" + ($group | @json | .[1:-1]) + 
              "\", " + ($name | @json | .[1:-1]) +
              "\n" + $url
            ' >> "$OUTPUT"

            # Final cleanup: remove malformed entries
            sed -i '/^$/d; /^#EXTINF/ {N; /http/!D;}' "$OUTPUT"

            COUNT=$(grep -c '^http' "$OUTPUT" 2>/dev/null || echo 0)
            echo "‚úÖ Success! $COUNT Tamil movies from $HOST"

            if [ "$COUNT" -gt 0 ]; then
              FOUND=1
              break
            else
              echo "‚ö†Ô∏è No valid streams ‚Äî trying next host‚Ä¶"
            fi
          done

          if [ "$FOUND" -eq 0 ]; then
            echo "üí• All hosts failed or returned 0 valid Tamil movies."
            exit 1
          fi

      - name: Commit and push (if changed)
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"

          if git add tamil_movies.m3u && ! git diff --staged --quiet; then
            git commit -m "ü§ñ Auto-update: Tamil Movies M3U ($(date -u))"
            git push
          else
            echo "‚è≠Ô∏è No changes ‚Äî skipping commit."
          fi
